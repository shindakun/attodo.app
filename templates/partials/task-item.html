{{define "task-item.html"}}
<div class="task-item {{if .Completed}}completed{{end}}" id="task-{{.RKey}}">
    <div class="task-view">
        <h4>
            {{.Title}}
            {{if .IsRecurring}}
            <span style="display: inline-block; padding: 0.125rem 0.5rem; background-color: var(--pico-primary-background); color: var(--pico-primary); border: 1px solid var(--pico-primary); border-radius: 12px; font-size: 0.75rem; font-weight: 500; margin-left: 0.5rem;" title="This task recurs automatically">üîÑ Recurring</span>
            {{end}}
        </h4>
        {{if .Description}}
        <p>{{.Description}}</p>
        {{end}}

        {{if .Tags}}
        <div class="task-tags" style="margin-top: 0.5rem;">
            {{range .Tags}}
            <span class="tag" data-tag="{{.}}">{{.}}</span>
            {{end}}
        </div>
        {{end}}

        {{if .DueDate}}
        <div class="task-due-date {{if .IsOverdue}}overdue{{end}} {{if .IsDueToday}}due-today{{end}} {{if .IsDueSoon}}due-soon{{end}}" style="margin-top: 0.5rem;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.25rem;">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
            <time datetime="{{formatDate .DueDate}}">
                Due: {{.DueDateDisplay}}
            </time>
        </div>
        {{end}}

        <small>Created: <time class="local-time" datetime="{{formatDate .CreatedAt}}">{{formatDate .CreatedAt}}</time></small>
        {{if .CompletedAt}}
        <small> ‚Ä¢ Completed: <time class="local-time" datetime="{{formatDate .CompletedAt}}">{{formatDate .CompletedAt}}</time></small>
        {{end}}
        {{if .Lists}}
        <div style="margin-top: 0.5rem;">
            <small style="color: var(--pico-muted-color);">
                In lists:
                {{range $index, $list := .Lists}}
                    {{if $index}}, {{end}}<a href="/app/lists/view/{{$list.RKey}}" style="font-size: inherit;">{{$list.Name}}</a>
                {{end}}
            </small>
        </div>
        {{end}}
    </div>

    <div class="task-edit" style="display: none;">
        <form
            hx-patch="/app/tasks"
            hx-target="#task-{{.RKey}}"
            hx-swap="outerHTML swap:500ms"
        >
            <input type="hidden" name="rkey" value="{{.RKey}}">
            <label>
                Title
                <input type="text" name="title" value="{{.Title}}" required>
            </label>
            <label>
                Description
                <textarea name="description" rows="3">{{.Description}}</textarea>
            </label>

            <label>
                Tags (comma-separated)
                <input type="text" name="tags" id="tags-{{.RKey}}" value="{{joinTags .Tags}}" placeholder="work, urgent, personal">
                <small>Separate tags with commas (max 10 tags, 30 characters each). Emoji supported! üéØ</small>
            </label>

            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.5rem;">
                <label>
                    Due Date (optional)
                    <input type="date" name="dueDate" id="dueDate-{{.RKey}}"
                           {{if .DueDate}}data-utc-date="{{formatDate .DueDate}}"{{end}}>
                </label>
                <label>
                    Time (optional)
                    <input type="time" name="dueTime" id="dueTime-{{.RKey}}"
                           {{if .DueDate}}data-utc-date="{{formatDate .DueDate}}"{{end}}>
                </label>
            </div>
            <small style="display: block; margin-top: -0.5rem; margin-bottom: 0.5rem;">Or type date/time in title (e.g., "tomorrow at 3pm" or "11/26 3:30pm meeting")</small>

            {{if .IsRecurring}}
            <div style="padding: 0.75rem; background-color: var(--pico-card-sectioning-background-color); border-radius: var(--pico-border-radius); margin-top: 0.5rem;">
                <small style="color: var(--pico-muted-color);">
                    ‚ÑπÔ∏è This is a recurring task. To change the recurrence pattern, delete this task and create a new one.
                </small>
            </div>
            {{else}}
            <label>
                <input type="checkbox" name="isRecurring" id="isRecurring-edit-{{.RKey}}" onchange="toggleEditRecurringOptions('{{.RKey}}')">
                Make this a recurring task üîÑ
            </label>

            <div id="recurring-options-edit-{{.RKey}}" style="display: none; padding: 1rem; background-color: var(--pico-card-sectioning-background-color); border-radius: var(--pico-border-radius); margin-top: 0.5rem;">
                <div style="padding: 0.5rem; background-color: var(--pico-primary-background); border-left: 3px solid var(--pico-primary); margin-bottom: 1rem;">
                    <small style="color: var(--pico-primary);">
                        ‚ö†Ô∏è <strong>Recurring tasks require a due date</strong> to calculate the next occurrence. Please set a due date above.
                    </small>
                </div>

                <label for="frequency-edit-{{.RKey}}">
                    Repeats
                    <select name="frequency" id="frequency-edit-{{.RKey}}">
                        <option value="daily">Daily</option>
                        <option value="weekly" selected>Weekly</option>
                        <option value="monthly">Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </label>

                <label for="interval-edit-{{.RKey}}">
                    Every
                    <input type="number" name="interval" id="interval-edit-{{.RKey}}" value="1" min="1" max="30" style="width: 80px; display: inline-block;">
                    <span id="interval-unit-edit-{{.RKey}}">week(s)</span>
                </label>

                <div id="days-of-week-selector-edit-{{.RKey}}" style="margin-top: 0.5rem;">
                    <small>On these days:</small>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.25rem;">
                        <label style="display: inline-flex; align-items: center; margin: 0;">
                            <input type="checkbox" name="daysOfWeek" value="1" style="margin: 0 0.25rem 0 0;"> Mon
                        </label>
                        <label style="display: inline-flex; align-items: center; margin: 0;">
                            <input type="checkbox" name="daysOfWeek" value="2" style="margin: 0 0.25rem 0 0;"> Tue
                        </label>
                        <label style="display: inline-flex; align-items: center; margin: 0;">
                            <input type="checkbox" name="daysOfWeek" value="3" style="margin: 0 0.25rem 0 0;"> Wed
                        </label>
                        <label style="display: inline-flex; align-items: center; margin: 0;">
                            <input type="checkbox" name="daysOfWeek" value="4" style="margin: 0 0.25rem 0 0;"> Thu
                        </label>
                        <label style="display: inline-flex; align-items: center; margin: 0;">
                            <input type="checkbox" name="daysOfWeek" value="5" style="margin: 0 0.25rem 0 0;"> Fri
                        </label>
                        <label style="display: inline-flex; align-items: center; margin: 0;">
                            <input type="checkbox" name="daysOfWeek" value="6" style="margin: 0 0.25rem 0 0;"> Sat
                        </label>
                        <label style="display: inline-flex; align-items: center; margin: 0;">
                            <input type="checkbox" name="daysOfWeek" value="0" style="margin: 0 0.25rem 0 0;"> Sun
                        </label>
                    </div>
                </div>

                <small style="display: block; margin-top: 0.5rem; color: var(--pico-muted-color);">
                    üí° When you complete this recurring task, a new one will be automatically created with the next due date.
                </small>
            </div>
            {{end}}

            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button type="submit">Save</button>
                <button type="button" onclick="cancelEdit('{{.RKey}}')">Cancel</button>
            </div>
        </form>
    </div>

    <div class="task-actions">
        <button onclick="showAddToList('{{.RKey}}', '{{.URI}}')">
            Add to List
        </button>
        <button onclick="startEdit('{{.RKey}}')">
            Edit
        </button>
        <button
            hx-put="/app/tasks"
            hx-vals='{"rkey": "{{.RKey}}"}'
            hx-target="#task-{{.RKey}}"
            hx-swap="outerHTML swap:500ms"
        >
            {{if .Completed}}Mark Incomplete{{else}}Mark Complete{{end}}
        </button>
        <button
            class="delete"
            hx-delete="/app/tasks?rkey={{.RKey}}"
            hx-target="#task-{{.RKey}}"
            hx-swap="outerHTML swap:500ms"
            hx-confirm="Are you sure you want to delete this task?"
        >
            Delete
        </button>
    </div>
</div>
{{end}}
